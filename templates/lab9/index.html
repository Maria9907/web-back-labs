{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block script %}{% endblock %}

{% block main %}
<div class="new-year-theme">
    <h1>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è üéÑ</h1>
    
    <div >
        <p>–í—ã –æ—Ç–∫—Ä—ã–ª–∏: <span id="user-opened-count">{{ opened_count }}</span> –∏–∑ 3 –∫–æ—Ä–æ–±–æ–∫</p>
        <p>–û—Å—Ç–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—ã—Ö: <span id="closed-count">{{ closed_count }}</span></p>
        <p id="auth-status" style="display: none;">
            –°—Ç–∞—Ç—É—Å: <span id="auth-text">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
        </p>
    </div>
    
    <div>
        <div  style="display: none;">
            <h3>üéÖ –î–ª—è –î–µ–¥ –ú–æ—Ä–æ–∑–∞:</h3>
            <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å (secret)" style="padding: 8px; margin-right: 10px;">
            <button id="login-btn" class="btn">–í–æ–π—Ç–∏ –∫–∞–∫ –î–µ–¥ –ú–æ—Ä–æ–∑</button>
        </div>
        
        <div  style="display: none;">
            <h3>üéÖ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –î–µ–¥ –ú–æ—Ä–æ–∑</h3>
            <button id="reset-btn" class="btn santa-btn">–ù–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ –∑–∞–Ω–æ–≤–æ</button>
            <button id="logout-btn" class="btn">–í—ã–π—Ç–∏</button>
        </div>
    </div>
    
    <!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ —Å –ø–æ–¥–∞—Ä–∫–æ–º -->
    <div id="gift-popup" class="gift-popup" style="display: none;">
        <div class="gift-popup-content">
            <button class="close-popup" onclick="closeGiftPopup()">√ó</button>
            <h3> –í–∞—à –ø–æ–¥–∞—Ä–æ–∫!</h3>
            <p id="gift-message-text"></p>
            <div id="gift-preview"></div>
            <button class="ok-button" onclick="closeGiftPopup()">OK</button>
        </div>
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ—Ä–æ–±–æ–∫ -->
    <div class="boxes-container">
        {% for box in boxes %}
        <div class="gift-box {% if box.is_opened %}opened{% endif %}" 
             data-id="{{ box.box_id }}"
             data-gift="{{ box.gift_image }}"
             data-message="{{ box.message }}"
             style="left: {{ positions[loop.index0][0] }}%; top: {{ positions[loop.index0][1] }}%;">
            <div class="box-content">
                {% if box.is_opened %}
                    <div class="after-open-box">
                        <img src="/static/lab9/opened_box.png" alt="–û—Ç–∫—Ä—ã—Ç–∞—è –∫–æ—Ä–æ–±–∫–∞" class="box-img">
                    </div>
                    <div class="box-status">–û—Ç–∫—Ä—ã—Ç–∞</div>
                {% else %}
                    <div class="before-open-box">
                        <img src="/static/lab9/box_closed_{{ loop.index }}.png" alt="–ö–æ—Ä–æ–±–∫–∞ {{ loop.index }}" class="box-img">
                    </div>
                    <div>–ó–∞–∫—Ä—ã—Ç–∞</div>
                {% endif %}
                <div class="box-number">–ö–æ—Ä–æ–±–∫–∞ {{ loop.index }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>


<script>

let openedBoxes = [];

function checkAuthStatus() {
    fetch('/lab9/rest-api/auth/status')
        .then(function(data) {
            return data.json();
        })
        .then(function(result) {
            const authSection = document.getElementById('auth-section');
            const santaSection = document.getElementById('santa-section');
            const authText = document.getElementById('auth-text');
            const authStatus = document.getElementById('auth-status');
            
            if (result.authenticated) {
                authSection.style.display = 'none';
                santaSection.style.display = 'block';
                authText.textContent = '–î–µ–¥ –ú–æ—Ä–æ–∑';
                authStatus.style.display = 'block';
            } else {
                authSection.style.display = 'block';
                santaSection.style.display = 'none';
                authText.textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                authStatus.style.display = 'block';
            }
        })
        .catch(function(error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
        });
}

function openBox(boxId) {
    fetch(`/lab9/rest-api/boxes/${boxId}/open`, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json'
        }
    })
    .then(function(response) {
        if (!response.ok) {
            return response.json().then(function(err) { 
                throw err; 
            });
        }
        return response.json();
    })
    .then(function(data) {
        if (data.error) {
            showError(data.error);
        } else {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            document.getElementById('user-opened-count').textContent = data.user_opened_count;
            document.getElementById('closed-count').textContent = data.closed_count;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥–∞—Ä–æ–∫
            showGiftPopup(data.message, data.gift);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥ –∫–æ—Ä–æ–±–∫–∏
            updateBoxAfterOpen(boxId, data.gift);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –æ—Ç–∫—Ä—ã—Ç–æ–π –∫–æ—Ä–æ–±–∫–∏
            openedBoxes.push(boxId);
        }
    })
    .catch(function(error) {
        showError(error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–æ—Ä–æ–±–∫–∏');
    });
}

function resetAllBoxes() {
    if (!confirm('–î–µ–¥ –ú–æ—Ä–æ–∑, –≤—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ –∑–∞–Ω–æ–≤–æ?')) {
        return;
    }
    
    fetch('/lab9/rest-api/boxes/reset', {
        method: 'POST'
    })
    .then(function(response) {
        if (!response.ok) {
            return response.json().then(function(err) { 
                throw err; 
            });
        }
        return response.json();
    })
    .then(function(data) {
        if (data.error) {
            showError(data.error);
        } else {
            alert(data.message);
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
        }
    })
    .catch(function(error) {
        showError(error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –∫–æ—Ä–æ–±–æ–∫');
    });
}

function login() {
    const password = document.getElementById('password').value;
    
    if (!password) {
        showError('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
        return;
    }
    
    fetch('/lab9/rest-api/auth/login', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ password: password })
    })
    .then(function(response) {
        if (!response.ok) {
            return response.json().then(function(err) { 
                throw err; 
            });
        }
        return response.json();
    })
    .then(function(data) {
        if (data.error) {
            showError(data.error);
        } else {
            alert(data.message);
            checkAuthStatus(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            document.getElementById('password').value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
        }
    })
    .catch(function(error) {
        showError(error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
    });
}

function logout() {
    fetch('/lab9/rest-api/auth/logout', {
        method: 'POST'
    })
    .then(function() {
        alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
        checkAuthStatus(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    })
    .catch(function(error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ');
    });
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

function showError(message) {
    alert(message);
}

function closeGiftPopup() {
    document.getElementById('gift-popup').style.display = 'none';
}

function showGiftPopup(message, giftImage) {
    document.getElementById('gift-message-text').textContent = message;
    document.getElementById('gift-preview').innerHTML = `<img src="${giftImage}" alt="–í–∞—à –ø–æ–¥–∞—Ä–æ–∫">`;
    document.getElementById('gift-popup').style.display = 'flex';
}

function updateBoxAfterOpen(boxId, giftImage) {
    const boxElement = document.querySelector(`.gift-box[data-id="${boxId}"]`);
    if (!boxElement) return;
    
    // –ú–µ–Ω—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –æ–±—â—É—é –æ—Ç–∫—Ä—ã—Ç—É—é –∫–æ—Ä–æ–±–∫—É
    const img = boxElement.querySelector('.box-img');
    if (img) {
        img.src = '/static/lab9/opened_box.png';
    }
    
    // –ú–µ–Ω—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —Å—Ç–∞—Ç—É—Å
    const container = boxElement.querySelector('.before-open-box');
    if (container) {
        container.className = 'after-open-box';
    }
    
    const status = boxElement.querySelector('.box-status');
    if (status) {
        status.textContent = '–û—Ç–∫—Ä—ã—Ç–∞';
    }
    
    // –ü–æ–º–µ—á–∞–µ–º –∫–æ—Ä–æ–±–∫—É –∫–∞–∫ –æ—Ç–∫—Ä—ã—Ç—É—é
    boxElement.classList.add('opened');
}

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========

document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    checkAuthStatus();
    
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–æ—Ä–æ–±–∫–∏
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–æ—Ä–æ–±–∫–∏
    const boxes = document.querySelectorAll('.gift-box:not(.opened)');
    boxes.forEach(function(box) {
        box.addEventListener('click', function() {
            if (this.classList.contains('opened')) {
                showError('–≠—Ç–∞ –∫–æ—Ä–æ–±–∫–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞!');
                return;
            }
            
            const boxId = this.dataset.id;
            openBox(parseInt(boxId));
        });
    });
    
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
        loginBtn.addEventListener('click', login);
    }
    
    const resetBtn = document.getElementById('reset-btn');
    if (resetBtn) {
        resetBtn.addEventListener('click', resetAllBoxes);
    }
    
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
    }
    
    
});
</script>
{% endblock %}